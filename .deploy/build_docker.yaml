---

.build_docker_image:
  image: docker:stable
  stage: build
  environment:
    name: $DEPLOYMENT_ENV
  variables:
    DOCKERFILE: .deploy/Dockerfile
    DOCKER_BUILD_ARGS: ''
    DOCKER_CACHE_MAIN_TAG: develop
    DOCKER_CACHE_BUILD_BRANCH: develop
    DOCKER_CACHE_BUILD_TARGET: build
    DOCKER_CACHE_BUILD_TAG: $DOCKER_CACHE_BUILD_BRANCH-$DOCKER_CACHE_BUILD_TARGET-$DEPLOYMENT_ENV
  script:
    - if [ -z "$DOCKER_REGISTRY_IMAGE" ]; then export DOCKER_REGISTRY_IMAGE=$DOCKER_REGISTRY/$DOCKER_REGISTRY_PREFIX/$CI_PROJECT_NAME; fi
    - echo $DOCKER_REGISTRY_IMAGE;
    - if [ -z "$TAG" ]; then export TAG=$CI_COMMIT_SHORT_SHA-$DEPLOYMENT_ENV; fi
    - echo "docker login -u $DOCKER_REGISTRY_USER -p $DOCKER_REGISTRY_PASSWORD $DOCKER_REGISTRY"
    - docker login -u $DOCKER_REGISTRY_USER -p $DOCKER_REGISTRY_PASSWORD $DOCKER_REGISTRY
    - echo "Inserv .env file from CI variables"
    - rm -f .env && rm -f .env.*
    - cat $DOCKER_BUILD_ENV > .env
    - docker build --rm $DOCKER_BUILD_ARGS --tag $DOCKER_REGISTRY_IMAGE:$TAG -f ${DOCKERFILE} .
    - docker push $DOCKER_REGISTRY_IMAGE:$TAG
    - docker logout $DOCKER_REGISTRY
  tags:
    - docker

.release_docker_image:
  image: docker:stable
  stage: release
  environment:
    name: $DEPLOYMENT_ENV
  script:
    - if [ -z "$DOCKER_REGISTRY_IMAGE" ]; then export DOCKER_REGISTRY_IMAGE=$DOCKER_REGISTRY/$DOCKER_REGISTRY_PREFIX/$CI_PROJECT_NAME; fi
    - if [ -z "$TAG" ]; then export TAG=${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}-$DEPLOYMENT_ENV; fi
    - docker login -u $DOCKER_REGISTRY_USER -p $DOCKER_REGISTRY_PASSWORD $DOCKER_REGISTRY
    - docker pull $DOCKER_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA-$DEPLOYMENT_ENV
    - docker tag $DOCKER_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA-$DEPLOYMENT_ENV $DOCKER_REGISTRY_IMAGE:$TAG
    - docker tag $DOCKER_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA-$DEPLOYMENT_ENV $DOCKER_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG-$DEPLOYMENT_ENV
    - docker push $DOCKER_REGISTRY_IMAGE:$TAG
    - docker push $DOCKER_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG-$DEPLOYMENT_ENV
    - |
      if [ ! -z "$CI_COMMIT_TAG" ]; then
        echo $CI_COMMIT_TAG
        docker tag $DOCKER_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA-$DEPLOYMENT_ENV $DOCKER_REGISTRY_IMAGE:$CI_COMMIT_TAG
        docker tag $DOCKER_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA-$DEPLOYMENT_ENV $DOCKER_REGISTRY_IMAGE:$CI_COMMIT_TAG-$CI_COMMIT_SHORT_SHA
        docker push $DOCKER_REGISTRY_IMAGE:$CI_COMMIT_TAG
        docker push $DOCKER_REGISTRY_IMAGE:$CI_COMMIT_TAG-$CI_COMMIT_SHORT_SHA
      fi
    - docker logout $DOCKER_REGISTRY
  tags:
    - docker
